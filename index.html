<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GROUPE EXPRESS - Notifications Push</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-messaging-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .notification-card {
            background: white;
            border-radius: 24px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .notification-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: bellRing 2s infinite;
        }

        @keyframes bellRing {
            0%, 50%, 100% { transform: rotate(0deg); }
            10%, 30% { transform: rotate(-15deg); }
            20%, 40% { transform: rotate(15deg); }
        }

        h1 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        .description {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .notification-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .notification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .notification-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }

        .token-display {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 12px;
            word-break: break-all;
            font-size: 0.85rem;
            color: #495057;
            display: none;
        }

        .messages-container {
            margin-top: 2rem;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .message-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            text-align: left;
            border-left: 4px solid #667eea;
        }

        .message-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .message-body {
            color: #666;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="notification-card">
        <div class="notification-icon">üîî</div>
        <h1>Notifications Push FCM</h1>
        <p class="description">
            Activez les notifications pour recevoir un message de remerciement toutes les 2 secondes 
            lorsque vous n'√™tes pas sur la page.
        </p>
        
        <button id="enable-notifications" class="notification-btn">
            üîî Activer les notifications
        </button>
        
        <button id="test-notification" class="notification-btn" style="display: none;">
            üì¨ Envoyer une notification test
        </button>
        
        <div id="status" class="status"></div>
        
        <div id="token-display" class="token-display"></div>
        
        <div id="messages-container" class="messages-container">
            <h3 style="margin-bottom: 1rem; color: #667eea;">Messages re√ßus :</h3>
            <div id="messages-list"></div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBsGrY-AqYMoI70kT3WMxLgW0HwYA4KyaQ",
            authDomain: "livraison-c8498.firebaseapp.com",
            projectId: "livraison-c8498",
            storageBucket: "livraison-c8498.firebasestorage.app",
            messagingSenderId: "403240604780",
            appId: "1:403240604780:web:77d84ad03d68bdaddfb449",
            measurementId: "G-5YF89BZ5RY"
        };

        // VAPID Key
        const vapidKey = 'BGL6IVuJSbQjI69fot6FvfGEBmq1t4_hPP1Dhx_KYiIEFCrOLjtYFWjID_MlteNgJtm7FFbdIfBygdRi_IF-qng';

        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Obtenir l'instance Messaging
        let messaging;
        try {
            messaging = firebase.messaging();
            console.log('Firebase Messaging initialis√© avec succ√®s');
        } catch (error) {
            console.error('Erreur initialisation Firebase Messaging:', error);
            showStatus('Erreur: ' + error.message, 'error');
        }

        // Variables globales
        let notificationInterval = null;
        let messageCounter = 0;

        // √âl√©ments DOM
        const enableBtn = document.getElementById('enable-notifications');
        const testBtn = document.getElementById('test-notification');
        const statusDiv = document.getElementById('status');
        const tokenDisplay = document.getElementById('token-display');
        const messagesContainer = document.getElementById('messages-container');
        const messagesList = document.getElementById('messages-list');

        // Fonction pour afficher le statut
        function showStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Fonction pour afficher un message re√ßu
        function displayMessage(title, body) {
            messageCounter++;
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-item';
            messageDiv.innerHTML = `
                <div class="message-title">#${messageCounter} - ${title}</div>
                <div class="message-body">${body}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            messagesList.insertBefore(messageDiv, messagesList.firstChild);
            messagesContainer.style.display = 'block';
        }

        // Messages de remerciement
        const thankYouMessages = [
            {
                title: "üôè Merci de votre confiance !",
                body: "GROUPE EXPRESS vous remercie pour votre fid√©lit√©."
            },
            {
                title: "‚≠ê Vous √™tes formidable !",
                body: "Merci de choisir GROUPE EXPRESS pour vos repas."
            },
            {
                title: "üéâ Merci √† vous !",
                body: "Votre satisfaction est notre priorit√© chez GROUPE EXPRESS."
            },
            {
                title: "üíù Toute notre gratitude !",
                body: "GROUPE EXPRESS appr√©cie votre soutien continu."
            },
            {
                title: "üåü Merci beaucoup !",
                body: "Ensemble, nous construisons une meilleure exp√©rience."
            },
            {
                title: "üôå Un grand merci !",
                body: "GROUPE EXPRESS est honor√© de vous servir."
            },
            {
                title: "üíñ Merci infiniment !",
                body: "Votre pr√©sence fait toute la diff√©rence."
            },
            {
                title: "‚ú® Merci pour tout !",
                body: "GROUPE EXPRESS vous souhaite une excellente journ√©e."
            }
        ];

        // Fonction pour obtenir un message al√©atoire
        function getRandomThankYouMessage() {
            return thankYouMessages[Math.floor(Math.random() * thankYouMessages.length)];
        }

        // Fonction pour envoyer une notification locale
        function sendLocalNotification() {
            if (!('Notification' in window)) {
                console.error('Ce navigateur ne supporte pas les notifications');
                return;
            }

            if (Notification.permission === 'granted') {
                const message = getRandomThankYouMessage();
                
                // Afficher dans l'interface
                displayMessage(message.title, message.body);

                // Envoyer la notification si l'utilisateur n'est pas sur la page
                if (document.hidden) {
                    const notification = new Notification(message.title, {
                        body: message.body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üçΩÔ∏è</text></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üîî</text></svg>',
                        tag: 'groupe-express-thanks',
                        requireInteraction: false,
                        silent: false
                    });

                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                }
            }
        }

        // Fonction pour d√©marrer l'envoi p√©riodique
        function startPeriodicNotifications() {
            if (notificationInterval) {
                clearInterval(notificationInterval);
            }

            // Envoyer une notification toutes les 2 secondes
            notificationInterval = setInterval(() => {
                sendLocalNotification();
            }, 2000);

            showStatus('‚úÖ Notifications activ√©es ! Vous recevrez un message toutes les 2 secondes.', 'success');
            testBtn.style.display = 'block';
        }

        // Fonction pour arr√™ter les notifications
        function stopPeriodicNotifications() {
            if (notificationInterval) {
                clearInterval(notificationInterval);
                notificationInterval = null;
            }
        }

        // Demander la permission et obtenir le token
        async function requestPermission() {
            try {
                showStatus('‚è≥ Demande de permission en cours...', 'info');

                // Demander la permission pour les notifications
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log('Permission accord√©e');
                    
                    // Obtenir le token FCM
                    try {
                        const token = await messaging.getToken({ vapidKey: vapidKey });
                        
                        if (token) {
                            console.log('Token FCM obtenu:', token);
                            tokenDisplay.textContent = `Token FCM: ${token}`;
                            tokenDisplay.style.display = 'block';
                            
                            // Sauvegarder le token
                            localStorage.setItem('fcm_token', token);
                            
                            // D√©marrer les notifications p√©riodiques
                            startPeriodicNotifications();
                            
                            // Changer le bouton
                            enableBtn.textContent = 'üîï D√©sactiver les notifications';
                            enableBtn.onclick = disableNotifications;
                            
                        } else {
                            showStatus('‚ùå Impossible d\'obtenir le token FCM', 'error');
                        }
                    } catch (tokenError) {
                        console.error('Erreur lors de l\'obtention du token:', tokenError);
                        // Continuer quand m√™me avec les notifications locales
                        startPeriodicNotifications();
                        showStatus('‚ö†Ô∏è Notifications locales activ√©es (FCM non disponible)', 'info');
                    }
                    
                } else if (permission === 'denied') {
                    showStatus('‚ùå Permission refus√©e. Veuillez autoriser les notifications dans les param√®tres de votre navigateur.', 'error');
                } else {
                    showStatus('‚ö†Ô∏è Permission ignor√©e', 'info');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                showStatus('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // Fonction pour d√©sactiver les notifications
        function disableNotifications() {
            stopPeriodicNotifications();
            showStatus('üîï Notifications d√©sactiv√©es', 'info');
            enableBtn.textContent = 'üîî Activer les notifications';
            enableBtn.onclick = requestPermission;
            testBtn.style.display = 'none';
        }

        // Gestionnaire de messages en premier plan
        if (messaging) {
            messaging.onMessage((payload) => {
                console.log('Message re√ßu en premier plan:', payload);
                
                const title = payload.notification?.title || 'GROUPE EXPRESS';
                const body = payload.notification?.body || 'Nouveau message';
                
                displayMessage(title, body);
                
                // Afficher une notification m√™me en premier plan
                if (Notification.permission === 'granted') {
                    new Notification(title, {
                        body: body,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üçΩÔ∏è</text></svg>',
                    });
                }
            });
        }

        // Bouton pour activer les notifications
        enableBtn.addEventListener('click', requestPermission);

        // Bouton pour envoyer une notification test
        testBtn.addEventListener('click', () => {
            sendLocalNotification();
            showStatus('‚úÖ Notification test envoy√©e !', 'success');
        });

        // V√©rifier si les notifications sont d√©j√† autoris√©es au chargement
        window.addEventListener('load', () => {
            if (Notification.permission === 'granted') {
                const savedToken = localStorage.getItem('fcm_token');
                if (savedToken) {
                    tokenDisplay.textContent = `Token FCM sauvegard√©: ${savedToken}`;
                    tokenDisplay.style.display = 'block';
                }
                showStatus('‚ÑπÔ∏è Les notifications sont d√©j√† autoris√©es. Cliquez sur "Activer" pour d√©marrer.', 'info');
            }
        });

        // G√©rer la visibilit√© de la page
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Page en arri√®re-plan - Les notifications seront envoy√©es');
            } else {
                console.log('Page active - Les notifications seront affich√©es dans l\'interface');
            }
        });

        // Nettoyer l'intervalle quand la page est ferm√©e
        window.addEventListener('beforeunload', () => {
            stopPeriodicNotifications();
        });

        // Log pour le debugging
        console.log('Application de notifications initialis√©e');
        console.log('VAPID Key:', vapidKey);
        console.log('Support des notifications:', 'Notification' in window);
        console.log('Permission actuelle:', Notification.permission);
    </script>

    <!-- Service Worker Registration -->
    <script>
        // Enregistrer le service worker pour FCM
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                .then((registration) => {
                    console.log('Service Worker enregistr√© avec succ√®s:', registration.scope);
                    
                    // Utiliser ce service worker pour Firebase Messaging
                    if (messaging) {
                        messaging.useServiceWorker(registration);
                    }
                })
                .catch((error) => {
                    console.error('Erreur lors de l\'enregistrement du Service Worker:', error);
                });
        }
    </script>
</body>
</html>
