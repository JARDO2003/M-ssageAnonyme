<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Forum Anonyme - Design Spectaculaire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --dark-gradient: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-light: rgba(255, 255, 255, 0.9);
      --text-muted: rgba(255, 255, 255, 0.6);
      --shadow-neon: 0 0 20px rgba(102, 126, 234, 0.3);
      --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      width: 100vw;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 16px;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: 
        radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 200, 255, 0.1) 0%, transparent 50%),
        linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%),
        url('https://images.unsplash.com/photo-1518837695005-2083093ee35b?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80');
      background-size: cover, cover, cover, cover, cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--text-light);
      touch-action: manipulation;
      overflow-x: hidden;
    }

    .cosmic-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    }

    .container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(20px);
      position: relative;
      z-index: 10;
    }

    .header {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 0 0 30px 30px;
      padding: 20px 20px 15px;
      text-align: center;
      box-shadow: var(--shadow-glass), var(--shadow-neon);
      position: sticky;
      top: 0;
      z-index: 100;
      margin: 0 10px;
      margin-top: 10px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff 0%, #a8edea 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
      letter-spacing: 1px;
    }

    .header .subtitle {
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 400;
      line-height: 1.4;
      opacity: 0.9;
    }

    #signup-form {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .signup-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      padding: 35px 25px;
      box-shadow: var(--shadow-glass), var(--shadow-neon);
      width: 100%;
      max-width: 400px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .signup-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(from 0deg, transparent, rgba(102, 126, 234, 0.1), transparent);
      animation: rotate 4s linear infinite;
      z-index: -1;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .signup-card h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 15px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .signup-card p {
      color: var(--text-muted);
      margin-bottom: 25px;
      font-size: 15px;
      line-height: 1.5;
    }

    #forum {
      display: none;
      flex: 1;
      flex-direction: column;
      min-height: 0;
      padding: 0 10px;
      animation: slideIn 0.6s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 15px;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      margin-bottom: 15px;
      box-shadow: var(--shadow-glass);
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }

.message {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 15px 18px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      animation: messageSlide 0.4s ease-out;
      position: relative;
      overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .message.selected, .message:hover {
      box-shadow: 0 0 16px 2px #4facfe99, var(--shadow-neon);
      background: rgba(79, 172, 254, 0.07);
    }
    .message .reply-btn {
      position: absolute;
      right: 18px;
      top: 12px;
      background: var(--glass-bg);
      border: none;
      color: #4facfe;
      font-size: 17px;
      border-radius: 10px;
      cursor: pointer;
      padding: 3px 10px;
      opacity: 0.8;
      transition: background 0.2s, opacity 0.2s;
      z-index: 3;
      display: none;
    }
    .message:hover .reply-btn { display: block; }

    .message .reply-quote {
      font-size: 13px;
      color: #9ad6ff;
      background: rgba(79, 172, 254, 0.08);
      border-left: 3px solid #4facfe;
      padding: 5px 10px;
      border-radius: 8px;
      margin-bottom: 7px;
      margin-left: 36px;
      word-break: break-word;
    }

    /* ... (continue le style responsive comme avant) ... */
    /* Ajoute une badge de notification simple */
    .notif-badge {
      position: absolute;
      top: 3px;
      right: 2px;
      background: #f5576c;
      color: #fff;
      font-size: 11px;
      border-radius: 8px;
      padding: 1px 7px;
      font-weight: 600;
      z-index: 99;
      box-shadow: 0 0 10px #f5576c33;
      display: none;
    }
    /* Style pour notification toast */
    .toast-notif {
      position: fixed;
      left: 50%;
      bottom: 40px;
      transform: translateX(-50%);
      background: var(--accent-gradient);
      color: #fff;
      border-radius: 16px;
      padding: 14px 27px;
      font-size: 15px;
      font-weight: 500;
      box-shadow: 0 4px 20px #4facfe44;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s, transform 0.4s;
    }
    .toast-notif.active {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) scale(1.04);
    }
  </style>
</head>
<body>
  <div class="cosmic-particles" id="particles"></div>
  <div class="container">
    <div class="header">
      <h1>ðŸŒŒ Forum Cosmique Anonyme</h1>
      <div class="subtitle">Explorez l'univers des conversations anonymes</div>
      <span class="notif-badge" id="notifBadge"></span>
    </div>
    <div id="signup-form">
      <div class="signup-card">
        <h2>ðŸš€ Embarquez dans l'Aventure</h2>
        <p>Entrez votre numÃ©ro de tÃ©lÃ©phone pour rejoindre notre communautÃ© cosmique. Vos messages restent complÃ¨tement anonymes dans cet univers digital !</p>
        <form id="registerForm">
          <input type="tel" id="phone" name="phone" required pattern="[0-9]{7,15}" autocomplete="tel" placeholder="ðŸŒŸ Votre numÃ©ro de tÃ©lÃ©phone">
          <button type="submit" class="signup-btn">âœ¨ Entrer dans le Cosmos</button>
        </form>
      </div>
    </div>
    <div id="forum">
      <div class="messages" id="messages"></div>
      <div class="sticker-panel" id="stickerPanel">
        <div class="sticker" data-sticker="ðŸ˜€">ðŸ˜€</div>
        <div class="sticker" data-sticker="ðŸ˜‚">ðŸ˜‚</div>
        <!-- ... (reste des stickers) ... -->
        <div class="sticker" data-sticker="ðŸŒˆ">ðŸŒˆ</div>
      </div>
      <div class="message-input-container">
        <button type="button" class="sticker-btn" id="stickerToggle" aria-label="Stickers">ðŸ˜Š</button>
        <form id="messageForm">
          <input type="text" id="message" placeholder="âœ¨ Partagez vos pensÃ©es cosmiques..." required maxlength="256" autocomplete="off">
          <button type="submit" class="send-btn" aria-label="Envoyer">ðŸš€</button>
        </form>
      </div>
    </div>
    <div class="toast-notif" id="toastNotif"></div>
  </div>
  <script>
    // ... (particules et firebase config inchangÃ©s) ...

    // --- Ajout notification toast ---
    function showToast(msg) {
      const toast = document.getElementById('toastNotif');
      toast.textContent = msg;
      toast.classList.add('active');
      setTimeout(() => toast.classList.remove('active'), 3000);
    }
    // --- Badge notification ---
    function setNotifBadge(count) {
      const badge = document.getElementById('notifBadge');
      badge.textContent = count;
      badge.style.display = count > 0 ? 'inline-block' : 'none';
    }
    // --- RÃ©ponses ---
    let replyToMsg = null;
    function setReplyTo(msgId, username, text) {
      replyToMsg = msgId;
      messageInput.placeholder = `RÃ©pondre Ã  ${username} : ${text.slice(0, 30)}...`;
      messageInput.focus();
      messageInput.classList.add('replying');
    }
    function clearReply() {
      replyToMsg = null;
      messageInput.placeholder = "âœ¨ Partagez vos pensÃ©es cosmiques...";
      messageInput.classList.remove('replying');
    }
    // Gestion des messages et rÃ©ponses
    let latestMsgTimestamp = 0, unreadCount = 0, forumFocused = true;
    function loadMessages() {
      messagesDiv.innerHTML = '<div class="loading">ðŸŒŒ Synchronisation avec le cosmos...</div>';
      db.ref('messages').limitToLast(100).on('value', function(snapshot) {
        messagesDiv.innerHTML = '';
        const msgs = snapshot.val();
        let newLatest = latestMsgTimestamp;
        if (!msgs) {
          messagesDiv.innerHTML = '<div class="no-messages">ðŸŒŸ Soyez le premier Ã  illuminer ce cosmos avec votre message !</div>';
          setNotifBadge(0); return;
        }
        Object.entries(msgs).forEach(([msgId, m]) => {
          const div = document.createElement('div');
          div.className = m.isSticker ? 'message sticker' : 'message';
          div.dataset.msgid = msgId;

          // Affiche la citation si c'est une rÃ©ponse
          if (m.replyTo) {
            const repliedMsg = msgs[m.replyTo];
            if (repliedMsg) {
              div.innerHTML += `<div class="reply-quote"><b>${escapeHtml(repliedMsg.username)}</b>: ${escapeHtml(repliedMsg.text).slice(0, 80)}${repliedMsg.text.length > 80 ? '...' : ''}</div>`;
            }
          }
          const userAvatar = getUniqueAvatar();
          div.innerHTML += `
            <span class="user">
              <img src="${userAvatar}" alt="Avatar" class="user-avatar" onerror="this.style.display='none'">
              ${escapeHtml(m.username)}
            </span>
            <div class="content">${m.isSticker ? m.text : escapeHtml(m.text)}</div>
            <button class="reply-btn" title="RÃ©pondre">â†©</button>
          `;
          // Gestion bouton rÃ©ponse
          div.querySelector('.reply-btn').onclick = (e) => {
            e.stopPropagation();
            setReplyTo(msgId, m.username, m.text);
            vibrateOnAction();
          };
          div.onclick = () => {
            if (div.classList.contains('selected')) { div.classList.remove('selected'); clearReply(); }
            else {
              document.querySelectorAll('.message').forEach(d => d.classList.remove('selected'));
              div.classList.add('selected');
            }
          };
          messagesDiv.appendChild(div);
          newLatest = Math.max(newLatest, m.timestamp || 0);
        });
        // Scroll auto
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        // Notification
        if (newLatest > latestMsgTimestamp && !forumFocused) {
          unreadCount++;
          setNotifBadge(unreadCount);
          showToast('ðŸŒ  Nouveau message reÃ§u !');
          if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('Forum Cosmique', { body: 'Nouveau message reÃ§u !', icon: '/favicon.ico' });
          }
        }
        latestMsgTimestamp = newLatest;
      });
    }
    // Demande notification navigateur
    if ('Notification' in window && Notification.permission !== 'granted') {
      Notification.requestPermission();
    }
    // Focus/unfocus
    window.addEventListener('focus', () => { forumFocused = true; unreadCount=0; setNotifBadge(0); });
    window.addEventListener('blur', () => { forumFocused = false; });
    // -- Envoi message / rÃ©ponse
    messageForm.onsubmit = function(e) {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;
      const msg = {
        username, text, timestamp: Date.now(), isSticker: false,
        ...(replyToMsg ? { replyTo: replyToMsg } : {})
      };
      db.ref('messages').push(msg).then(() => {
        messageInput.value = ''; clearReply();
      });
    };
    // ... (reste du JS : stickers, cookies, login, resize, etc. inchangÃ©) ...
    // Ajout raccourci pour annuler la rÃ©ponse
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && replyToMsg) clearReply();
    });
    // ... (autres scripts, animation, vibration, etc. inchangÃ©s) ...
  </script>
</body>
</html>
